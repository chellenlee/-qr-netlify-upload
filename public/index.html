<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QR通過記録アプリ（修正版）</title>
</head>
<body>
  <h1>QRアップロード＆確認</h1>
  <input type="file" id="fileInput" accept=".csv" />
  <button id="uploadBtn">Dropboxアップロード</button>
  <button id="checkBtn">データ確認</button>
  <div id="result"></div>

  <script>
    const uploadBtn = document.getElementById('uploadBtn');
    const checkBtn = document.getElementById('checkBtn');
    const fileInput = document.getElementById('fileInput');
    const result = document.getElementById('result');

    uploadBtn.onclick = async () => {
      const file = fileInput.files[0];
      if (!file) return alert('ファイルを選択してください');
      const formData = new FormData();
      formData.append('file', file, file.name);

      try {
        const res = await fetch('/.netlify/functions/upload', { method: 'POST', body: formData });
        const data = await res.json();
        alert(data.success ? 'アップロード成功: ' + data.path : 'アップロード失敗: ' + data.error);
      } catch (e) {
        alert('エラー: ' + e.message);
      }
    };

    checkBtn.onclick = async () => {
      const staffName = prompt("担当者名を入力してください");
      if (!staffName) return;

      try {
        const res = await fetch('/.netlify/functions/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ staffName })
        });
        const data = await res.json();
        if (!data.files) throw new Error("ファイルがありません");

        const csvTexts = data.files;
        let recordMap = new Map();
        csvTexts.forEach(text => {
          const rows = text.trim().split("\n").slice(1);  // ← 検証ポイント：エスケープされた "\n"
          rows.forEach(row => {
            const cols = row.split(",");
            const key = `${cols[0]}_${cols[2]}`;
            const datetime = `${cols[6]} ${cols[7]}`;
            if (!recordMap.has(key) || datetime < recordMap.get(key).datetime) {
              recordMap.set(key, { row: cols, datetime });
            }
          });
        });

        const combined = [...recordMap.values()].map(v => v.row);
        combined.sort((a, b) => a[0].localeCompare(b[0]) || `${a[6]} ${a[7]}`.localeCompare(`${b[6]} ${b[7]}`));

        const table = document.createElement("table");
        const header = ["地点ID", "地点名", "部門", "ゼッケン番号", "氏名", "性別", "日付", "時刻", "担当者"];
        const thead = table.insertRow();
        header.forEach(h => thead.insertCell().textContent = h);
        combined.forEach(row => {
          const tr = table.insertRow();
          row.forEach(col => tr.insertCell().textContent = col);
        });

        result.innerHTML = "";
        result.appendChild(table);
      } catch (e) {
        result.textContent = "取得エラー: " + e.message;
      }
    };
  </script>
</body>
</html>
