<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>橘湾岸ＱＲ2025秋 (Firebase版)</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
        console.log('ServiceWorker registered with scope:', registration.scope);
      }).catch(function(error) {
        console.log('ServiceWorker registration failed:', error);
      });
    }
  </script>

  <style>
    /* ▼▼▼ デザイン（CSS）を完全に復元しました ▼▼▼ */
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; font-size: 18px; }
    #title-banner {
      background-color: #003366; /* 紺色背景 */
      color: white;              /* 白抜き文字 */
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }
    /* レイアウト調整 */
    #setup, #reader, #result, #history { margin: 20px; }
    
    /* 入力欄のデザイン */
    #setup input, #setup select {
      text-align: left;
      text-indent: 2em;
      width: 80%;
      margin-bottom: 10px;
      font-size: 20px;
    }
    
    /* 動画サイズ（元の比率に復元） */
    video {
      width: 90vw;
      height: 65vh;               /* 90vwではなく65vhに戻しました */
      margin-top: 10px;
      object-fit: cover;
    }

    /* テーブルデザイン（復元） */
    table { width: 95%; margin: 10px auto; border-collapse: collapse; font-size: 18px; }
    th, td { border: 1px solid #ccc; padding: 10px; font-size: 18px; }
    
    input, select, button { padding: 12px; font-size: 20px; margin: 8px; }
    #message { font-size: 22px; font-weight: bold; color: green; margin: 15px; }

    /* ボタンのグラデーションと立体感（復元） */
    .save-button, .start-button {
      background: linear-gradient(#888888, #666666);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 20px;
      border-radius: 8px;
      box-shadow: 0 5px #444444;
      cursor: pointer;
      display: inline-block;
    }
    .save-button:active, .start-button:active {
      box-shadow: 0 2px #444444;
      transform: translateY(3px);
    }

    /* ポップアップ関連 */
    #popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #popup {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 80%;
      max-width: 400px;
    }
    #popup h2 { margin-top: 0; font-size: 24px; }
    #popup p { margin: 5px 0; font-size: 20px; }
    #popup button { padding: 10px 20px; margin: 10px; font-size: 20px; }
  </style>
</head>

<body>

<div id="title-banner">橘湾岸ＱＲ2025秋</div>

<div id="setup">
  <h2 style="text-align:left; margin-left: 2em;">担当者名と地点を設定</h2>
  <input type="text" id="staffName" placeholder="担当者名を入力">
  <br>
  <select id="location">
    <option value="">地点を選択</option>
  </select>
  <br>
  <button class="start-button" onclick="startApp()">開始</button>
</div>

<div id="reader" style="display:none;">
  <h3 id="message">読み取り中...</h3>
  <video id="video" playsinline></video>
  <br>
  <button class="save-button" onclick="endApp()">終了</button>
</div>

<div id="result" style="display:none;">
  <div id="latest"></div>
</div>

<div id="history" style="display:none;">
  <h3>読み取り履歴</h3>
  <table>
    <thead>
      <tr>
        <th>地点ID</th><th>地点名</th><th>部門</th><th>ゼッケン</th><th>氏名</th><th>性別</th><th>日付</th><th>時刻</th><th>担当者</th>
      </tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>

<div id="popup-overlay">
  <div id="popup">
    <h2 id="popup-title">チェックOK</h2>
    <p id="popup-info"></p>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// ▼▼▼ 1. グローバル変数とFirebase設定を先に定義 ▼▼▼
let firestore;
let staff = '';
let selectedLocationId = '';
let selectedLocationName = '';
let codeReader = null;
let locations = []; // 動的ロードのため空にする
let scannedData = []; // 履歴データ用

const firebaseConfig = {
  apiKey: "AIzaSyD_Aic5iQ7OYGO9qTv0patspCKbwsuYcs8",
  authDomain: "tachibana-wangan.firebaseapp.com",
  projectId: "tachibana-wangan",
  storageBucket: "tachibana-wangan.firebasestorage.app",
  messagingSenderId: "963128842192",
  appId: "1:963128842192:web:5ee0eb05d3df5e7c63cbd5"
};

// ▼▼▼ 2. すべての関数を先に定義 ▼▼▼

/**
 * アプリの初期化ロジック（地点マスターをFirestoreから読み込む）
 */
async function initializeAppLogic() {
  const savedStaff = localStorage.getItem('staffName');
  const savedLocationId = localStorage.getItem('locationId');
  const savedHistory = localStorage.getItem('history');
  
  if
