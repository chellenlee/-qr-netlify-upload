<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ©˜æ¹¾å²¸ï¼±ï¼²2025ç§‹ (Firebaseç‰ˆ)</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
        console.log('ServiceWorker registered with scope:', registration.scope);
      }).catch(function(error) {
        console.log('ServiceWorker registration failed:', error);
      });
    }
  </script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; font-size: 18px; }
    #title-banner {
      background-color: #003366; /* ç´ºè‰²èƒŒæ™¯ */
      color: white;              /* ç™½æŠœãæ–‡å­— */
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }
    /* #history ã‚’å‰Šé™¤ */
    #setup, #reader, #result { margin: 20px; }
    #setup input, #setup select {
      text-align: left;
      text-indent: 2em;
      width: 80%;
      margin-bottom: 10px;
      font-size: 20px;
    }
    video {
      width: 90vw;
      height: 90vw;
      margin-top: 10px;
      object-fit: cover;
    }
    /* tableé–¢é€£ã‚’å‰Šé™¤ (historyå‰Šé™¤ã®ãŸã‚) */
    input, select, button { padding: 12px; font-size: 20px; margin: 8px; }
    #message { font-size: 22px; font-weight: bold; color: green; margin: 15px; }

    .save-button, .start-button {
      background: linear-gradient(#888888, #666666);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 20px;
      border-radius: 8px;
      box-shadow: 0 5px #444444;
      cursor: pointer;
      display: inline-block;
    }
    .save-button:active, .start-button:active {
      box-shadow: 0 2px #444444;
      transform: translateY(3px);
    }

    #popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #popup {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 80%;
      max-width: 400px;
    }
    #popup h2 { margin-top: 0; font-size: 24px; }
    #popup p { margin: 5px 0; font-size: 20px; }
    #popup button { padding: 10px 20px; margin: 10px; font-size: 20px; }
  </style>
</head>

<body>

<div id="title-banner">æ©˜æ¹¾å²¸ï¼±ï¼²2025ç§‹</div>

<div id="setup">
  <h2 style="text-align:left; margin-left: 2em;">æ‹…å½“è€…åã¨åœ°ç‚¹ã‚’è¨­å®š</h2>
  <input type="text" id="staffName" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›">
  <br>
  <select id="location">
    <option value="">åœ°ç‚¹ã‚’é¸æŠ</option>
  </select>
  <br>
  <button class="start-button" onclick="startApp()">é–‹å§‹</button>
  </div>

<div id="reader" style="display:none;">
  <h3 id="message">èª­ã¿å–ã‚Šä¸­...</h3>
  <video id="video" playsinline></video>
  <br>
  <button class="save-button" onclick="endApp()">çµ‚äº†</button>
</div>

<div id="result" style="display:none;">
  <div id="latest"></div>
</div>

<div id="popup-overlay">
  <div id="popup">
    <h2 id="popup-title">ãƒã‚§ãƒƒã‚¯OK</h2>
    <p id="popup-info"></p>
    </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// â–¼â–¼â–¼ 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨Firebaseè¨­å®šã‚’å…ˆã«å®šç¾© â–¼â–¼â–¼
let firestore;
let staff = '';
let selectedLocationId = '';
let selectedLocationName = '';
let codeReader = null;
let locations = []; // å‹•çš„ãƒ­ãƒ¼ãƒ‰ã®ãŸã‚ç©ºã«ã™ã‚‹

const firebaseConfig = {
Â  apiKey: "AIzaSyD_Aic5iQ7OYGO9qTv0patspCKbwsuYcs8",
Â  authDomain: "tachibana-wangan.firebaseapp.com",
Â  projectId: "tachibana-wangan",
Â  storageBucket: "tachibana-wangan.firebasestorage.app",
Â  messagingSenderId: "963128842192",
Â  appId: "1:963128842192:web:5ee0eb05d3df5e7c63cbd5"
};

// â–¼â–¼â–¼ 2. ã™ã¹ã¦ã®é–¢æ•°ã‚’å…ˆã«å®šç¾© â–¼â–¼â–¼

/**
Â * ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
Â */
async function initializeAppLogic() {
Â  const savedStaff = localStorage.getItem('staffName');
Â  const savedLocationId = localStorage.getItem('locationId');
Â Â 
Â  if (savedStaff) document.getElementById('staffName').value = savedStaff;

Â  const locationSelect = document.getElementById('location');
Â Â 
Â  // 1. èª­ã¿è¾¼ã¿ä¸­ã®è¡¨ç¤ºã«å¤‰æ›´
Â  locationSelect.innerHTML = '<option value="">åœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼èª­è¾¼ä¸­...</option>';
Â  locationSelect.disabled = true;

Â  try {
Â  Â  // 2. Firestoreã® 'locations_master' ã‹ã‚‰ 'id' é †ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
Â  Â  const snapshot = await firestore.collection("locations_master")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .orderBy("id", "asc")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .get();

Â  Â  if (snapshot.empty) {
Â  Â  Â  console.error("åœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼ãŒç©ºã§ã™ã€‚");
Â  Â  Â  locationSelect.innerHTML = '<option value="">åœ°ç‚¹å–å¾—å¤±æ•—</option>';
Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
Â  Â  locations = []; // ã‚°ãƒ­ãƒ¼ãƒãƒ«é…åˆ—ã‚’ãƒªã‚»ãƒƒãƒˆ
Â  Â  locationSelect.innerHTML = '<option value="">åœ°ç‚¹ã‚’é¸æŠ</option>'; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ

Â  Â  snapshot.forEach(doc => {
Â  Â  Â  const loc = doc.data();
Â  Â  Â  locations.push(loc); // ã‚°ãƒ­ãƒ¼ãƒãƒ«é…åˆ—ã«æ ¼ç´

Â  Â  Â  // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã« <option> ã‚’è¿½åŠ 
Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  option.value = loc.id;
Â  Â  Â  option.textContent = loc.name;
Â  Â  Â  locationSelect.appendChild(option);
Â  Â  });
Â  Â Â 
Â  Â  // 4. ä¿å­˜ã•ã‚Œã¦ã„ãŸåœ°ç‚¹ã‚’å¾©å…ƒ
Â  Â  if (savedLocationId) {
Â  Â  Â  locationSelect.value = savedLocationId;
Â  Â  }

Â  } catch (err) {
Â  Â  console.error("åœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
Â  Â  locationSelect.innerHTML = '<option value="">èª­è¾¼ã‚¨ãƒ©ãƒ¼</option>';
Â  } finally {
Â  Â  // 5. å‡¦ç†å®Œäº†å¾Œã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æœ‰åŠ¹åŒ–
Â  Â  locationSelect.disabled = false;
Â  }
}

/**
Â * ã‚¢ãƒ—ãƒªï¼ˆã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”»é¢ï¼‰ã‚’é–‹å§‹ã™ã‚‹
Â */
function startApp() {
Â  staff = document.getElementById('staffName').value.trim();
Â  const locationId = document.getElementById('location').value;

Â  if (!staff || !locationId) {
Â  Â  showCustomPopup({
Â  Â  Â  title: "ç¢ºèª",
Â  Â  Â  message: "æ‹…å½“è€…åã¨åœ°ç‚¹ã‚’å…¥åŠ›ãƒ»é¸æŠã—ã¦ãã ã•ã„ã€‚",
Â  Â  Â  buttons: [{ text: "OK", value: true }]
Â  Â  });
Â  Â  return;
Â  }
Â Â 
Â  localStorage.setItem('staffName', staff);
Â  selectedLocationId = locationId;
Â  // ğŸš¨ locationsé…åˆ—ãŒéåŒæœŸã§è¨­å®šã•ã‚ŒãŸå¾Œã§å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€.findãŒå®‰å…¨ã«å‹•ä½œã—ã¾ã™
Â  selectedLocationName = locations.find(loc => loc.id == locationId).name;

Â  localStorage.setItem('locationId', selectedLocationId);
Â  localStorage.setItem('locationName', selectedLocationName);Â 

Â  document.getElementById('setup').style.display = 'none';
Â  document.getElementById('reader').style.display = '';
Â  document.getElementById('result').style.display = '';

Â  startScanner();
}

/**
Â * QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’é–‹å§‹ã™ã‚‹ (ä¿®æ­£ç‰ˆ)
Â */
function startScanner() {
Â  const video = document.getElementById('video');
Â  if (!codeReader) {
Â  Â  codeReader = new ZXing.BrowserQRCodeReader();
Â  }
Â  document.getElementById('message').textContent = 'èª­ã¿å–ã‚Šä¸­...';

Â  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
Â  codeReader.decodeFromVideoDevice(undefined, video, (result, err) => {Â 
Â  Â  if (result) {
Â  Â  Â  codeReader.reset();
Â  Â  Â  document.getElementById('message').textContent = 'èª­ã¿å–ã‚ŠæˆåŠŸ';

Â  Â  Â  const text = result.text.trim();
Â  Â  Â  const parts = text.split('/');
Â  Â  Â Â 
Â  Â  Â  if (parts.length >= 4) {
Â  Â  Â  Â  const [division, bibNumber, runnerName, gender] = parts;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const scanTimeObject = new Date();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const scanData = {
Â  Â  Â  Â  Â  id: selectedLocationId,
Â  Â  Â  Â  Â  name: selectedLocationName,
Â  Â  Â  Â  Â  division,
Â  Â  Â  Â  Â  bibNumber,
Â  Â  Â  Â  Â  runnerName,
Â  Â  Â  Â  Â  gender,
Â  Â  Â  Â  Â  scanTimestamp: firebase.firestore.Timestamp.fromDate(scanTimeObject),
Â  Â  Â  Â  Â  date: scanTimeObject.toLocaleDateString('ja-JP'),
Â  Â  Â  Â  Â  time: scanTimeObject.toLocaleTimeString('ja-JP'),
Â  Â  Â  Â  Â  staff,
Â  Â  Â  Â  Â  serverTimestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  };

Â  Â  Â  Â  showPopup(scanData);Â 
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById('message').textContent = 'ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™';
Â  Â  Â  Â  setTimeout(startScanner, 1000);
Â  Â  Â  }
Â  Â  }
Â  }, { video: { facingMode: "environment" } });
}

/**
Â * èª­ã¿å–ã‚Šçµæœã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹
Â */
function showPopup(scanData) {
Â  const overlay = document.getElementById('popup-overlay');
Â  const title = document.getElementById('popup-title');
Â  const info = document.getElementById('popup-info');
Â  const popup = document.getElementById('popup');

Â  title.textContent = "ãƒã‚§ãƒƒã‚¯OK";
Â  title.style.color = "green";

Â  info.innerHTML = `
Â  Â  åœ°ç‚¹ï¼š${scanData.name}<br>
Â  Â  éƒ¨é–€ï¼š${scanData.division}<br>
Â  Â  ã‚¼ãƒƒã‚±ãƒ³ï¼š${scanData.bibNumber}<br>
Â  Â  æ°åï¼š${scanData.runnerName}
Â  `;

Â  popup.querySelectorAll('button').forEach(btn => btn.remove());

Â  const okBtn = document.createElement('button');
Â  okBtn.textContent = "OK";
Â  okBtn.onclick = () => {
Â  Â  uploadToFirebase(scanData);Â 
Â  Â  continueScan();Â 
Â  };
Â  popup.appendChild(okBtn);

Â  const endBtn = document.createElement('button');
Â  endBtn.textContent = "çµ‚äº†";
Â  endBtn.onclick = endApp;
Â  popup.appendChild(endBtn);

Â  overlay.style.display = 'flex';
}

/**
Â * ã‚¹ã‚­ãƒ£ãƒ³ã‚’ç¶šè¡Œã™ã‚‹
Â */
function continueScan() {
Â  document.getElementById('popup-overlay').style.display = 'none';
Â  startScanner();Â 
}

/**
Â * ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã€è¨­å®šç”»é¢ã«æˆ»ã‚‹
Â */
function endApp() {
Â  if (codeReader) {
Â  Â  codeReader.reset();
Â  }
Â  document.getElementById('popup-overlay').style.display = 'none';
Â  document.getElementById('setup').style.display = '';
Â  document.getElementById('reader').style.display = 'none';
Â  document.getElementById('result').style.display = 'none';
}

/**
Â * èª­ã¿å–ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’Firebase Firestoreã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ (é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚ã‚Š)
Â */
async function uploadToFirebase(data) {
Â  if (!firestore) {
Â  Â  console.error("Firestore is not initialized.");
Â  Â  document.getElementById('message').textContent = 'DBæœªæ¥ç¶šã‚¨ãƒ©ãƒ¼';Â 
Â  Â  return;
Â  }

Â  const docId = `${data.id}_${data.bibNumber}`;
Â  const docRef = firestore.collection("scans").doc(docId);

Â  try {
Â  Â  await firestore.runTransaction(async (transaction) => {
Â  Â  Â  const doc = await transaction.get(docRef);
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  throw new Error("already-exists");G
Â  Â  Â  }
Â  Â  Â  transaction.set(docRef, data);
Â  Â  });
Â  Â  console.log("Transaction successfully committed (åˆå›):", docId);
Â  Â  document.getElementById('message').textContent = `${data.bibNumber} ä¿å­˜å®Œäº†`;

Â  } catch (error) {
Â  Â  if (error.message === "already-exists") {
Â  Â  Â  console.warn("Transaction failed (é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³):", docId);
Â  Â  Â  document.getElementById('message').textContent = `${data.bibNumber} ã¯èª­ã¿å–ã‚Šæ¸ˆã¿`;
Â  Â  } else {
Â  Â  Â  console.error("Transaction failed: ", error);
Â  Â  Â  document.getElementById('message').textContent = `ä¿å­˜ã‚¨ãƒ©ãƒ¼(ã‚­ãƒ£ãƒƒã‚·ãƒ¥è©¦è¡Œ)`;
Â  Â  }
Â  }
}

/**
Â * æ±ç”¨çš„ãªã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãªã©ã«ä½¿ç”¨ï¼‰
Â */
function showCustomPopup({ title = "", message = "", buttons = [], callback = null }) {
Â  const overlay = document.getElementById('popup-overlay');
Â  const popup = document.getElementById('popup');
Â  const titleElem = document.getElementById('popup-title');
Â  const infoElem = document.getElementById('popup-info');

Â  titleElem.textContent = title;
Â  titleElem.style.color = (title === "ã‚¨ãƒ©ãƒ¼" ? "red" : "");Â 
Â  infoElem.innerHTML = message;

Â  popup.querySelectorAll('button').forEach(btn => btn.remove());

Â  buttons.forEach(({ text, value }) => {
Â  Â  const btn = document.createElement('button');
Â  Â  btn.textContent = text;
Â  Â  btn.onclick = () => {
Â  Â  Â  overlay.style.display = 'none';
Â  Â  Â  if (callback) callback(value);
Â  Â  };
Â  Â  popup.appendChild(btn);
Â  });

Â  overlay.style.display = 'flex';
}

// â–¼â–¼â–¼ 3. æœ€å¾Œã«ã€åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆinitializeAppLogicã‚’å‘¼ã³å‡ºã™ï¼‰ â–¼â–¼â–¼

try {
  // FirebaseåˆæœŸåŒ–
  firebase.initializeApp(firebaseConfig);
  firestore = firebase.firestore();

  // Firestore persistence ã‚’è©¦ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚å•é¡Œãªã—ï¼‰
  firestore.enablePersistence().catch((err) => {
    console.warn("Persistence disabled:", err.code);
  });

  // â˜… Android ã§ã¯ initializeAppLogic() ã®å®Ÿè¡Œã‚’å°‘ã—é…ã‚‰ã›ã‚‹ã¨å®‰å®šã™ã‚‹
  setTimeout(() => {
    initializeAppLogic();
  }, 300);

} catch (e) {
  console.error("Firebase initialization error:", e);
  alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚åˆæœŸåŒ–ã¯å®Ÿè¡Œ
  initializeAppLogic();
}
</script>
</body>
</html>
